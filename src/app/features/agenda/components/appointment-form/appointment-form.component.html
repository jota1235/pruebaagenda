<!-- Header -->
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="closeModal()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>{{ mode === 'edit' ? 'Editar Cita' : 'Agendar Cita' }}</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="togglePromo()">
        <ion-badge [color]="isPromo ? 'success' : 'medium'">Promo</ion-badge>
      </ion-button>
      <ion-button [disabled]="!isFormValid()" (click)="saveAppointment()">
        <ion-icon name="checkmark-outline" [color]="isFormValid() ? 'success' : 'medium'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Fecha y Hora -->
  <ion-toolbar class="datetime-toolbar">
    <div class="datetime-container" (click)="openDateTimePicker()" role="button" tabindex="0">
      <ion-icon name="calendar-outline" class="datetime-icon"></ion-icon>
      <span class="datetime-text">{{ selectedDateTime }}</span>
    </div>
  </ion-toolbar>
</ion-header>

<!-- Content -->
<ion-content class="appointment-content">

  <!-- Tabs -->
  <ion-segment [(ngModel)]="activeTab" (ionChange)="onTabChange($event)" class="tabs-segment">
    <ion-segment-button value="general">
      <ion-label>General</ion-label>
    </ion-segment-button>
    <ion-segment-button value="conceptos">
      <ion-label>Conceptos</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Tab General -->
  <div class="tab-content" *ngIf="activeTab === 'general'">

    <!-- Botones de Acciones (iconos superiores) -->
    <div class="action-buttons">
      <ion-button fill="solid" color="dark" size="small">
        <ion-icon name="add-outline"></ion-icon>
      </ion-button>
      <ion-button fill="solid" color="dark" size="small">
        <ion-icon name="search-outline"></ion-icon>
      </ion-button>
      <ion-button fill="solid" color="medium" size="small">
        <ion-icon name="person-outline"></ion-icon>
      </ion-button>
      <ion-button fill="solid" color="medium" size="small">
        <ion-icon name="document-text-outline"></ion-icon>
      </ion-button>
    </div>

    <!-- Cliente -->
    <div class="form-section">
      <ion-item class="form-item">
        <ion-label position="stacked" class="required-label">Cliente:</ion-label>
        <ion-searchbar
          [(ngModel)]="clientSearchQuery"
          (ionInput)="searchClients($event)"
          (ionChange)="searchClients($event)"
          placeholder="-- Seleccione --"
          [debounce]="300"
          [disabled]="false"
          type="text"
          inputmode="text"
          autocomplete="off"
          class="client-searchbar">
        </ion-searchbar>
      </ion-item>

      <!-- Resultados de búsqueda -->
      <ion-list *ngIf="clientResults.length > 0" class="search-results">
        <ion-item
          button
          *ngFor="let client of clientResults"
          (click)="selectClient(client)"
          class="search-result-item">
          <ion-label>
            <h3>{{ client.name }}</h3>
            <p *ngIf="client.phone">{{ client.phone }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </div>

    <!-- Personal -->
    <div class="form-section">
      <ion-item class="form-item">
        <ion-label position="stacked" class="required-label">Personal:</ion-label>
        <ion-select
          [(ngModel)]="selectedStaffId"
          placeholder="Seleccione personal"
          interface="action-sheet"
          class="staff-select">
          <ion-select-option *ngFor="let staff of staffList" [value]="staff.id">
            {{ staff.name }}
          </ion-select-option>
        </ion-select>
      </ion-item>
    </div>

    <!-- Mensaje vacío -->
    <div class="empty-message" *ngIf="addedServices.length === 0">
      <p>* No existen resultados para mostrar.</p>
    </div>

    <!-- Resumen de servicios agregados (si hay) -->
    <div class="services-summary" *ngIf="addedServices.length > 0">
      <h3 class="summary-title">Servicios agregados:</h3>
      <ion-list class="summary-list">
        <ion-item *ngFor="let service of addedServices" class="summary-item">
          <ion-label>
            <h3>{{ service.serviceName }}</h3>
            <p>Cantidad: {{ service.quantity }} | Duración: {{ service.duration }} min</p>
          </ion-label>
          <ion-button slot="end" fill="clear" (click)="removeService(service)">
            <ion-icon name="trash-outline" color="danger"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>

      <!-- Totales -->
      <div class="totals">
        <p><strong>Duración total:</strong> {{ totalDuration }} minutos</p>
        <p><strong>Fecha y hora:</strong> {{ selectedDateTime }}</p>
      </div>
    </div>

  </div>

  <!-- Tab Conceptos -->
  <div class="tab-content" *ngIf="activeTab === 'conceptos'">

    <!-- Servicio (Nombre) - Búsqueda con autocompletado -->
    <div class="form-section">
      <ion-item class="form-item">
        <ion-label position="stacked">Nombre:</ion-label>
        <ion-searchbar
          [(ngModel)]="serviceSearchQuery"
          (ionInput)="searchServices($event)"
          (ionChange)="searchServices($event)"
          placeholder="Buscar o escribir servicio..."
          [debounce]="300"
          [disabled]="false"
          type="text"
          inputmode="text"
          autocomplete="off"
          class="service-searchbar">
        </ion-searchbar>
      </ion-item>

      <!-- Resultados de búsqueda -->
      <div class="search-results" *ngIf="serviceResults.length > 0">
        <ion-list>
          <ion-item
            *ngFor="let service of serviceResults"
            button
            (click)="selectService(service)"
            class="search-result-item">
            <ion-label>
              <h3>{{ service.name }}</h3>
              <p>{{ service.duration }} min - ${{ service.price }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <!-- Indicador de servicio personalizado -->
      <div class="custom-service-hint" *ngIf="serviceSearchQuery && !selectedService && serviceResults.length === 0 && serviceSearchQuery.length >= 2">
        <ion-label color="primary">
          <small>✨ Se creará un servicio personalizado: "{{ serviceSearchQuery }}"</small>
        </ion-label>
      </div>
    </div>

    <!-- Precio (nuevo campo para servicios personalizados) -->
    <div class="form-section" *ngIf="serviceSearchQuery && !selectedService">
      <ion-item class="form-item">
        <ion-label position="stacked">Precio:</ion-label>
        <ion-input
          type="number"
          [(ngModel)]="servicePrice"
          [min]="0"
          placeholder="0"
          class="price-input">
        </ion-input>
      </ion-item>
    </div>

    <!-- Cantidad y Duración -->
    <ion-grid class="quantity-duration-grid">
      <ion-row>
        <ion-col size="6">
          <ion-item class="form-item">
            <ion-label position="stacked">Cantidad:</ion-label>
            <ion-input
              type="number"
              [(ngModel)]="serviceQuantity"
              [min]="1"
              [max]="10"
              class="quantity-input">
            </ion-input>
          </ion-item>
        </ion-col>
        <ion-col size="6">
          <ion-item class="form-item">
            <ion-label position="stacked">Duración:</ion-label>
            <ion-select
              [(ngModel)]="serviceDuration"
              interface="action-sheet"
              class="duration-select">
              <ion-select-option *ngFor="let option of durationOptions" [value]="option.value">
                {{ option.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Botón Agregar -->
    <div class="add-button-container">
      <ion-button
        expand="block"
        fill="solid"
        color="medium"
        [disabled]="!serviceSearchQuery || serviceSearchQuery.length < 2"
        (click)="addService()"
        class="add-service-button">
        Agregar
      </ion-button>
    </div>

    <!-- Lista de servicios agregados -->
    <div class="added-services-section">
      <h3 class="section-title" *ngIf="addedServices.length > 0">Servicios agregados:</h3>

      <ion-list *ngIf="addedServices.length > 0" class="added-services-list">
        <ion-item *ngFor="let service of addedServices" class="added-service-item">
          <ion-label>
            <h3>{{ service.serviceName }}</h3>
            <p>Cantidad: {{ service.quantity }} | Duración: {{ service.duration }} min</p>
          </ion-label>
          <ion-button slot="end" fill="clear" (click)="removeService(service)">
            <ion-icon name="trash-outline" color="danger"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>

      <!-- Mensaje vacío -->
      <div class="empty-message" *ngIf="addedServices.length === 0">
        <p>* No existen resultados para mostrar.</p>
      </div>
    </div>

  </div>

</ion-content>

<!-- Footer con botones -->
<ion-footer>
  <ion-toolbar>
    <ion-grid class="footer-buttons">
      <ion-row>
        <ion-col size="6">
          <ion-button
            expand="block"
            color="success"
            [disabled]="!isFormValid()"
            (click)="saveAppointment()"
            class="save-button">
            AGENDAR CITA
          </ion-button>
        </ion-col>
        <ion-col size="6">
          <ion-button
            expand="block"
            color="dark"
            (click)="closeModal()"
            class="cancel-button">
            <ion-icon name="close-outline" slot="start"></ion-icon>
            Cerrar
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-footer>

<!-- Modal de selector de fecha/hora -->
<ion-modal [isOpen]="showDateTimePicker" (didDismiss)="closeDateTimePicker()" [backdropDismiss]="false" class="datetime-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Seleccionar Fecha y Hora</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeDateTimePicker()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="datetime-modal-content">

      <!-- Calendario -->
      <div class="calendar-section">
        <h3 class="section-title">Fecha</h3>
        <ion-datetime
          #datetime
          [(ngModel)]="tempDateTime"
          presentation="date"
          [preferWheel]="false"
          [min]="minDate"
          [max]="maxDate"
          locale="es-MX"
          [showDefaultButtons]="false"
          class="custom-datetime">
        </ion-datetime>
      </div>

      <!-- Selector de Hora Moderno -->
      <div class="time-section">
        <h3 class="section-title">Hora</h3>

        <!-- Selector de hora (1-12) -->
        <div class="time-selector-group">
          <label class="time-label">Hora:</label>
          <div class="time-options">
            <button
              *ngFor="let hour of availableHours"
              class="time-option"
              [class.selected]="selectedHour === hour"
              (click)="selectHour(hour)">
              {{ hour }}
            </button>
          </div>
        </div>

        <!-- Selector de minutos (00, 30) -->
        <div class="time-selector-group">
          <label class="time-label">Minutos:</label>
          <div class="time-options">
            <button
              class="time-option"
              [class.selected]="selectedMinute === 0"
              (click)="selectMinute(0)">
              00
            </button>
            <button
              class="time-option"
              [class.selected]="selectedMinute === 30"
              (click)="selectMinute(30)">
              30
            </button>
          </div>
        </div>

        <!-- Selector AM/PM -->
        <div class="time-selector-group">
          <label class="time-label">Periodo:</label>
          <div class="time-options">
            <button
              class="time-option period-option"
              [class.selected]="selectedPeriod === 'AM'"
              (click)="selectPeriod('AM')">
              AM
            </button>
            <button
              class="time-option period-option"
              [class.selected]="selectedPeriod === 'PM'"
              (click)="selectPeriod('PM')">
              PM
            </button>
          </div>
        </div>

        <!-- Vista previa de hora seleccionada -->
        <div class="time-preview">
          <ion-icon name="time-outline"></ion-icon>
          <span>{{ getSelectedTimePreview() }}</span>
        </div>
      </div>

      <!-- Botones de confirmación -->
      <div class="datetime-buttons">
        <ion-button expand="block" fill="outline" color="medium" (click)="cancelDateTime()">
          Cancelar
        </ion-button>
        <ion-button expand="block" color="primary" (click)="confirmDateTime()">
          Confirmar
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
